<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar View - GearGuard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    {% include 'base.html' %}
    
    <div class="container">
        <h1>Preventive Maintenance Calendar</h1>
        
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prev-month" class="btn btn-secondary">Previous Month</button>
                <h2 id="current-month-year">December 2025</h2>
                <button id="next-month" class="btn btn-secondary">Next Month</button>
            </div>
            
            <div class="calendar-grid">
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
                
                <!-- Calendar days will be populated by JavaScript -->
                <div id="calendar-days"></div>
            </div>
        </div>
        
        <div class="requests-list">
            <h2>Upcoming Preventive Maintenance</h2>
            {% if requests %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Equipment</th>
                        <th>Subject</th>
                        <th>Technician</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in requests %}
                    <tr>
                        <td>{{ request.scheduled_date.strftime('%Y-%m-%d %H:%M') if request.scheduled_date else 'N/A' }}</td>
                        <td>{{ request.equipment.name if request.equipment else 'N/A' }}</td>
                        <td>{{ request.subject }}</td>
                        <td>{{ request.assigned_technician or 'Unassigned' }}</td>
                        <td>
                            <a href="{{ url_for('edit_request', id=request.id) }}" class="btn btn-info">Edit</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No preventive maintenance requests scheduled.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Hidden data element to pass request data to JavaScript -->
    <script id="requests-data" type="application/json">
        [
            {% for request in requests %}
            {
                "id": {{ request.id }},
                "date": "{{ request.scheduled_date.strftime('%Y-%m-%d %H:%M:%S') if request.scheduled_date else '2025-01-01 00:00:00' }}",
                "subject": "{{ request.subject }}",
                "equipment": "{{ request.equipment.name if request.equipment else 'N/A' }}",
                "technician": "{{ request.assigned_technician or 'Unassigned' }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentDate = new Date();
            const calendarDays = document.getElementById('calendar-days');
            const currentMonthYear = document.getElementById('current-month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            
            // Get calendar data from the hidden script element
            const requestsData = JSON.parse(document.getElementById('requests-data').textContent);
            
            function renderCalendar() {
                // Clear the calendar
                calendarDays.innerHTML = '';
                
                // Set the current month/year header
                const monthNames = ["January", "February", "March", "April", "May", "June",
                                    "July", "August", "September", "October", "November", "December"];
                currentMonthYear.textContent = monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
                
                // Get first day of month and number of days in month
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                const daysInMonth = lastDay.getDate();
                
                // Get day of week for first day (0 = Sunday, 1 = Monday, etc.)
                const firstDayOfWeek = firstDay.getDay();
                
                // Add empty cells for days before the first day of the month
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.classList.add('calendar-day', 'empty');
                    calendarDays.appendChild(emptyCell);
                }
                
                // Add cells for each day of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.classList.add('calendar-day');
                    
                    // Highlight today
                    const today = new Date();
                    if (day === today.getDate() && 
                        currentDate.getMonth() === today.getMonth() && 
                        currentDate.getFullYear() === today.getFullYear()) {
                        dayCell.classList.add('today');
                    }
                    
                    // Add date number
                    const dateDiv = document.createElement('div');
                    dateDiv.classList.add('date');
                    dateDiv.textContent = day;
                    dayCell.appendChild(dateDiv);
                    
                    // Add events for this day
                    const dayEvents = requestsData.filter(req => {
                        const reqDate = new Date(req.date);
                        return reqDate.getDate() === day && 
                               reqDate.getMonth() === currentDate.getMonth() && 
                               reqDate.getFullYear() === currentDate.getFullYear();
                    });
                    
                    if (dayEvents.length > 0) {
                        dayCell.classList.add('has-events');
                        const eventsDiv = document.createElement('div');
                        eventsDiv.classList.add('events');
                        
                        dayEvents.forEach(event => {
                            const eventDiv = document.createElement('div');
                            eventDiv.classList.add('event');
                            eventDiv.textContent = event.subject;
                            eventDiv.title = `${event.equipment} - ${event.technician}`;
                            eventsDiv.appendChild(eventDiv);
                        });
                        
                        dayCell.appendChild(eventsDiv);
                    }
                    
                    calendarDays.appendChild(dayCell);
                }
            }
            
            // Navigation
            prevMonthBtn.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            
            nextMonthBtn.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
            
            // Initial render
            renderCalendar();
        });
    </script>
</body>
</html>